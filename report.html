<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report</title>
</head>
<body>
    <div id="report-container"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            query, 
            where, 
            getDocs,
            collectionGroup 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyARzeyulL-4c_ATw7NcUP-gsUh2-qE3fNU",
            authDomain: "sigma-app-e9397.firebaseapp.com",
            projectId: "sigma-app-e9397",
            storageBucket: "sigma-app-e9397.firebasestorage.app",
            messagingSenderId: "561606435145",
            appId: "1:561606435145:web:c68e3629ce50215f177a98",
            measurementId: "G-1KG5C55LEB"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        function extractFullHTML(text) {
            // Regex to match from <!DOCTYPE html> to </html>, including newlines
            const htmlRegex = /<!DOCTYPE html>[\s\S]*?<\/html>/i;
            const match = text.match(htmlRegex);
            return match ? match[0] : "";
        }
        
        async function loadReport() {
            try {
                const params = new URLSearchParams(window.location.search);
                const rid = params.get('rid');

                if (!rid) {
                    document.getElementById('report-container').innerHTML = '<p>No report ID provided</p>';
                    return;
                }
                
                const reportsQuery = query(
                    collectionGroup(db, 'reports'),
                    where('reportId', '==', rid)
                );
                
                const querySnapshot = await getDocs(reportsQuery);
                
                if (querySnapshot.empty) {
                    console.log('‚ùå No report found with ID:', rid);
                    document.getElementById('report-container').innerHTML = '<p>No report found with this ID</p>';
                    return;
                }
                
                // Get the first document from the query
                const doc = querySnapshot.docs[0];
                const data = doc.data();
                const sanitized_html = extractFullHTML(data.html);
                
                // the final line to load the report into page.
                document.getElementById('report-container').innerHTML = sanitized_html;

            } catch (err) {
                console.error('Error:', err);
                document.getElementById('report-container').innerHTML = `<p>Error: ${err.message}</p>`;
            }
        }

        loadReport();
    </script>
</body>
</html>